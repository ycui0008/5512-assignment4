---
title: "ETC5512 Assignment 4: An Analysis of US Air Traffic"
subtitle: "ATL airport"
author: "Yuheng Cui"
date: "June 19,  2020"
bibliography: references.bib
biblio-style: authoryear-comp
output: 
  bookdown::html_document2:
    toc: true
    citation_package: biblatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      cache=TRUE, 
                      messages=FALSE, 
                      warning=FALSE)
library(tidyverse)
library(ggmap)
library(ggthemes)
# for exercise 2
library(lutz)
library(lubridate)
library(kableExtra)
library(janitor)
library(viridis)
library(bookdown)
library(gganimate)
# for exercise 3
library(polite)
library(rvest)
```


## `r emo::ji("airplane")` Exercise 1

### a. 
```{r read flight data, eval=FALSE}
d <- read_csv(here::here("raw_data","On_Time_Reporting_Carrier_On_Time_Performance_(1987_present)_2020_2.csv"))
```

```{r choose one carrier, eval=FALSE}
feb <- d %>%
  # Choose carrier "UA" and month Feb
  filter(Reporting_Airline == "UA", Month == 2)%>%
  # Choose ATL airport, according to arrive at/ departure from
  filter(Origin == "ATL" | Dest == "ATL")
```


```{r load_ATL_feb_UA.rda}
# load the rda file created in Exercise 1.b
load(file = here::here("data","ATL_feb_UA.rda"))
flight %>%
  select(Year, Month, DayofMonth, Reporting_Airline, Origin, Dest) %>%
  head() %>%
  kable(booktabs = TRUE, caption = "Carrier UA in ATL airport in Feb 2020") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```




Here, I chose the UA airline' flights related to ATL airport in Feb 2020.

First, I read the data from csv file. Then, I filter the data set and save the data set as rda file. Next, (in 1.b) I joined airport data set into the data set and save the new data set as rda file. Now, I can load the file to save directly.

### b. 
```{r read airport data, eval=FALSE}
d1 <- read_csv(here::here("raw_data","516691980_T_MASTER_CORD.csv"))
```


```{r join d1 into airport, eval=FALSE}
airport_location <- d1 %>%
  # select the airports were still on businesses at the time and located in the US
  filter(AIRPORT_IS_CLOSED == 0 & 
           AIRPORT_IS_LATEST == 1 &
           AIRPORT_COUNTRY_CODE_ISO == "US") %>% 
  # select useful columns only
  select(AIRPORT, DISPLAY_AIRPORT_NAME, LONGITUDE, LATITUDE)

flight <- feb %>%
  # combine flight data set with airport data set
  left_join(airport_location, by = c("Origin" = "AIRPORT")) %>%
  # rename origin airport longitude and latitude
  rename("Origin_lon" = "LONGITUDE","Origin_lat" = "LATITUDE") %>% 
  left_join(airport_location, by = c("Dest" = "AIRPORT")) %>%
  # rename dest airport longitude and latitude
  rename("Dest_lon" = "LONGITUDE","Dest_lat" = "LATITUDE") 

save(flight,file = here::here("data","ATL_feb_UA.rda"))
```

I join airport information data set into the data set created in last question. I used join function twice for "origin" and "dest" airports, respectively. At last, I saved the new data set as rda file.

### c. 
```{r generate a map of US}
usa_bbox <- c(-130, # min long
              20, # min lat
              -60, # max long
              55) # max lat

usa_map <- get_map(location = usa_bbox, source = "osm")
```


```{r choose UA in flight data set}
# load the rda file
load(file = here::here("data","ATL_feb_UA.rda"))

# select only carrier UA
flight_UA <-  flight%>%
  filter(Reporting_Airline == "UA")
```


```{r flight path}
ggmap(usa_map) + 
  # create purple lines between origin and dest airports
  geom_segment(data=flight_UA, 
                     aes(x=Origin_lon, 
                         xend=Dest_lon,
                         y=Origin_lat,
                         yend=Dest_lat), 
                     colour="#7434eb", size = 2, alpha=0.01) +
  # Red dots stand for different airports
  geom_point(data=flight, aes(x=Origin_lon, Origin_lat),
             colour="Red", alpha=0.1, size=1.5) +
  theme_map()
```

The level of transparency of the lines specifies how often does UA carry flights between ATL airport and other airports in Feb 2020. The deeper the color means more flights between the two airports.

## `r emo::ji("airplane")` Exercise 2

### a. 

```{r standardise timezone}
flights_NYtime <- flight %>%
  # remove missing values
  filter(!is.na(Origin_lon)) %>%
  filter(!is.na(Dest_lon)) %>%
  filter(!is.na(DepTime)) %>%
            # set timezone for origin airports
  mutate(origin_tz = tz_lookup_coords(Origin_lat,
                                      Origin_lon, 
                                      warn = FALSE),
           # set timezone for origin airports
         dest_tz = tz_lookup_coords(Dest_lat,
                                    Dest_lon,
                                    warn = FALSE)) %>%
  mutate(Dep_DateTime = paste0(FlightDate, 
                           " ",
                           substr(DepTime, 1, 2),":", 
                           substr(DepTime, 3, 4), ":00")) %>%
  mutate(Origin_DateTime_NY = force_tzs(ymd_hms(Dep_DateTime),
      tzones = origin_tz, tzone_out = "America/New_York")) %>% # Normalise Origin DateTime
  mutate(Arr_DateTime = paste0(FlightDate,
                               " ",
                               substr(ArrTime, 1, 2),":", 
                               substr(ArrTime, 3, 4), ":00")) %>%
  mutate(Dest_DateTime_NY = force_tzs(ymd_hms(Arr_DateTime),
      tzones = dest_tz, tzone_out = "America/New_York")) # Normalise Dest DateTime

flights_NYtime %>%
  select(Origin_DateTime_NY, Dest_DateTime_NY, Tail_Number, Origin, Dest) %>%
  head()%>%
  kable(booktabs = TRUE, caption = "Flights-after normalise as NY Time")%>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```



### b. 
```{r list of plane}
# the list of planes that has flown in and out of the selected airport
flights_NYtime %>%
  group_by(Tail_Number, DayofMonth) %>%
  tally() %>%
  filter(n == 2) %>%
  select(Tail_Number, DayofMonth)
```

```{r choose one plane from the list above}
# Select a plane whose tail number was N16234 flied on 3rd Feb 2020
day1 <- flights_NYtime %>%
  filter(Tail_Number == "N16234", DayofMonth == 3)

ggmap(usa_map) +
  geom_segment(data=day1, 
                     aes(x=Origin_lon, 
                         xend=Dest_lon,
                         y=Origin_lat,
                         yend=Dest_lat), 
                     colour="#7434eb", size = 1) +
  # Plot the Origin airports on the map
  geom_point(data=day1, aes(x=Origin_lon, y = Origin_lat),
             colour="Red", size=2) +
  # Plot the Dest airports on the map
  geom_point(data=day1, aes(x=Dest_lon, y = Dest_lat),
             colour="Red", size=2)
  theme_map()

```



### c. 

```{r, eval = FALSE}
# # This chunk was used to createt the function below
# test1 <- (0:(e3$AirTime[2]))
# 
# #longitude change sequence
# c(e3$Origin_lon[2]+((e3$Dest_lon[2] - e3$Origin_lon[2])*test1)/(e3$AirTime[2]))
# 
# #latitude change sequence
# c(e3$Origin_lat[2]+((e3$Dest_lat[2] - e3$Origin_lat[2])*test1)/(e3$AirTime[2]))
# 
# #time change
# c(e3$DepTime[2] + step1*(test1))
# 
# rep(e3$DepDelay[2], ((e3$AirTime[2])+1))
# 

```


```{r create function}
# The time interval is 15 mins
step <- hms("00:15:00") 

# Create a function used to generate flight path
pathtable <- function(data,i){
  test1 <- (0:(data$AirTime[i]%/%15-2))
  
  #longitude change sequence
  lon_incre <- c(((data$Dest_lon[i] - data$Origin_lon[i])*15*test1)/(data$AirTime[i]) + data$Origin_lon[i], data$Dest_lon[i])

  #latitude change sequence
  lat_incre <- c(((data$Dest_lat[i] - data$Origin_lat[i])*15*test1)/(data$AirTime[i]) + data$Origin_lat[i], data$Dest_lat[i])
  
  #time change
  time_incre <- c(data$DepTime[i] + step*test1, data$ArrTime[i])
  
  # paste DepDelay to the table
  DepDelay <- rep(data$DepDelay[i], ((data$AirTime[i]%/%15)))
  
  # Create the table
  tibble(
    DepTime = time_incre,
    Origin_lon = lon_incre,
    Origin_lat = lat_incre,
    DepDelay = DepDelay
  )
}
```

```{r one day and one plane}
e3 <- flights_NYtime %>%
  # choose one plane in 3rd Feb 2020
  filter(Tail_Number == "N16234", DayofMonth == 3) %>%
  select(DepTime, ArrTime, AirTime, Origin_lon, Origin_lat, Dest_lon, Dest_lat, DepDelay) %>%
  arrange(DepTime) %>%
  # 
  mutate(DepTime = paste0("2020-02-03 ",
                          substr(DepTime, 1, 2),
                          ":",
                          substr(DepTime, 3, 4))) %>%
  
  mutate(ArrTime = paste0("2020-02-03 ",
                          substr(ArrTime, 1, 2),
                          ":",
                          substr(ArrTime, 3, 4)))%>%
  mutate(DepTime = ymd_hm(DepTime),
         ArrTime = ymd_hm(ArrTime))
```


```{r the movement of one plance in one day}
path_1 <- bind_rows(pathtable(e3, 1), pathtable(e3, 2)) %>%
  arrange(DepTime) 

path_2 <- path_1 %>%
  mutate(DepTime = as.character(DepTime)) %>%
  mutate(DepTime = as.numeric(paste0(substr(DepTime,12,13),substr(DepTime, 15,16))))

```

```{r pathway plot}
ggmap(usa_map)+
  geom_point(data = path_2, aes(x = Origin_lon, y = Origin_lat, color = DepTime)) +
  geom_point(data=e3, aes(x=Origin_lon, y = Origin_lat),
             colour="Red", size=2) +
  geom_point(data=e3, aes(x=Dest_lon, y = Dest_lat),
             colour="Red", size=2)+
  scale_color_viridis_c(option = "C") +
  theme_map()
```

First, I created a function for drawing flight path of each plane. Then, I used to the function to create the table of flight path. Finally, I used the flight path table to draw the map. The colour represents the time. 

Sometimes, a dot are far away from previous dot. This situation only happens near the destination airports, because the time interval is greater than 15 minutes, unlike other dots.



### d. 

```{r one plane, animation.hook='gifski', out.width="100%", fig.width=4, fig.height=2}
for (i in 1:nrow(path_1)){
  print(ggmap(usa_map)+
          geom_point(data=e3, aes(x=Origin_lon, y = Origin_lat),
             colour="Red", size=2) +
          geom_point(data=e3, aes(x=Dest_lon, y = Dest_lat),
             colour="Red", size=2) +
          geom_point(data = path_1, aes(x = path_1[[2]][i], y = path_1[[3]][i]),color = 'White') +
  theme_map())
}
```




Here, the gif specifies the flight path of this plane, showing its position every 15 minutes.

### e. 

```{r choose one day and one carrier}
e4 <-flights_NYtime %>%
  filter(DayofMonth == 3, Reporting_Airline == "UA") %>%
  select(DepTime, ArrTime, AirTime, Origin_lon, Origin_lat, Dest_lon, Dest_lat, DepDelay) %>%
  arrange(DepTime) %>%
  mutate(DepTime = paste0("2020-02-03 ",
                          substr(DepTime, 1, 2),
                          ":",
                          substr(DepTime, 3, 4))) %>%
  mutate(ArrTime = paste0("2020-02-03 ",
                          substr(ArrTime, 1, 2),
                          ":",
                          substr(ArrTime, 3, 4)))%>%
  mutate(DepTime = ymd_hm(DepTime),
         ArrTime = ymd_hm(ArrTime))
```




```{r path_way}
# Create flight path table for exercise 2.E
path_way <- bind_rows(pathtable(e4,1),pathtable(e4,2),pathtable(e4,3),pathtable(e4,4),pathtable(e4,5),pathtable(e4,6),pathtable(e4,7),pathtable(e4,8),pathtable(e4,9),pathtable(e4,10),pathtable(e4,11),pathtable(e4,12),pathtable(e4,13),pathtable(e4,14),pathtable(e4,15),pathtable(e4,16),pathtable(e4,17),pathtable(e4,18),pathtable(e4,19),pathtable(e4,20),pathtable(e4,21),pathtable(e4,22),pathtable(e4,23),pathtable(e4,24),pathtable(e4,25),pathtable(e4,26)) %>%
  arrange(DepTime)
```


```{r animation2}
# Use gganimate to generate animated plot
ggmap(usa_map) +
  geom_point(data = path_way, aes(x= Origin_lon, y = Origin_lat,size = DepDelay)) +
  labs(title = "UA's flights in 2020-02-03", subtitle = "Time: {frame_time}") +
  transition_time(DepTime)
```

This animated plot specifies the flight paths of UA airline's planes on 3rd Feb 2020. There are some planes flied overnight; that's why the time frame shows the date of 2020-02-04. But it seems that the *transition_time* function cannot differentiate the date_time data. Thus, it was a little  

## `r emo::ji("airplane")` Exercise 3

```{r new data flights, eval=FALSE}
new_d <-read_csv(here::here("raw_data","On_Time_Reporting_Carrier_On_Time_Performance_(1987_present)_2020_2.csv")) %>%
  select(Year, Month, DayofMonth, DepTime, CRSDepTime, DepDelay, ArrTime, CRSArrTime, ArrDelay, Reporting_Airline, Flight_Number_Reporting_Airline, Tail_Number, Origin, Dest, AirTime, Distance) %>%
  rename(Day = DayofMonth, sched_dep_time = CRSDepTime, sched_arr_time = CRSArrTime, Carrier = Reporting_Airline, Flight = Flight_Number_Reporting_Airline) %>%
  mutate(hour = substr(sched_dep_time,1,2), 
         minute = substr(sched_dep_time, 3, 4)) %>%
  mutate(time_hour = paste0(Year, "-", Month, "-", Day, 
                            " ",
                            hour, ":", minute)) %>%
  mutate(time_hour = as_datetime(time_hour, format = "%Y-%m-%d %H:%M")) %>%
  mutate(Year = as.integer(Year),
         Month = as.integer(Month),
         Day = as.integer(Day),
         DepTime = as.integer(DepTime),
         sched_dep_time = as.integer(sched_dep_time),
         ArrTime = as.integer(ArrTime),
         sched_arr_time = as.integer(sched_arr_time),
         Flight = as.integer(Flight),
         hour = as.double(hour),
         minute = as.double(minute)) %>%
  filter(Origin == "ATL" | Dest == "ATL")

save(new_d, file = here::here("data","my_flights.rda"))
```

```{r new data airlines, eval=FALSE}
# Download raw data
url_airlines <- ("https://raw.githubusercontent.com/jpatokal/openflights/master/data/airlines.dat")
download.file(url_airlines, destfile = here::here("raw_data","airlines.csv"))

# Read data and add col names
new_airlines <- read_csv(here::here("raw_data","airlines.csv"), col_names = c("Airline ID", "Name", "Alias", "IATA", "ICAO", "Callsign", "Country", "Active")) %>%
  clean_names() %>% 
  filter(country == "United States", active =="Y")
  
new_airlines <- new_airlines %>%
  select(iata, name) %>%
  rename(carrier = iata)

save(new_airlines, file = here::here("data","my_airlines.rda"))
```

```{r new data airport, eval=FALSE}
# Download raw data
url_airport <- ("https://raw.githubusercontent.com/jpatokal/openflights/master/data/airports.dat") 
download.file(url_airport, destfile = here::here("raw_data","airports.csv"))

# Read data and add col names
new_airport <- read_csv(here::here("raw_data","airports.csv"), col_names = c("Airport ID", "Name", "City", "Country", "IATA", "ICAO", "Latitude", "Longitude", "Altitude", "Timezone", "DST", "Tz database time zone", "Type", "Source")) %>% 
  # use janitor package to clean the variable names
  clean_names() %>%
  # only select the airports located in the US
  filter(country == "United States")

new_airport <- new_airport %>%
  select(iata, name, latitude, longitude, altitude, timezone, dst, tz_database_time_zone) %>%
  # Change the variable names, make them as same as nycflight13::airports
  rename(faa = iata, lat = latitude, lon = longitude, alt = altitude, tz = timezone, tzone = tz_database_time_zone) %>%
  # Convert the data type, make them as same as nycflight13::airports
  mutate(dst = parse_character(dst))

save(new_airport, file = here::here("data","my_airports.rda"))
```

```{r new data planes, eval=FALSE}
raw_planes <- read_csv(here::here("raw_data/ReleasableAircraft/MASTER.TXT")) %>% clean_names()
raw_engine <- read_csv(here::here("raw_data/ReleasableAircraft/ENGINE.TXT")) %>% clean_names()
raw_acf <- read_csv(here::here("raw_data/ReleasableAircraft/ACFTREF.TXT")) %>% clean_names()
```

```{r ducumentation, eval=FALSE}
# Find out the Descriptions for type engine and type aircraft in the documentation
# Create table for Type Engine
type_engine <- tibble(type = c(0:11), engine_desc = c("None","Reciprocating", "Turbo-prop", "Turbo-shaft","Turbo-jet","Turbo-fan","Ramjet","2 Cycle","4 Cycle","Unknown","Electric","Rotary"))

# Create table for Type Aircraft
type_aircraft <- tibble(type = c(1:9,"H","O"), aircraft_desc = c("Glider","Balloon",
"Blimp/Dirigible",
"Fixed wing single engine",
"Fixed wing multi engine",
"Rotorcraft",
"Weight-shift-control",
"Powered Parachute",
"Gyroplane",
"Hybrid Lift",
"Other"))
```

```{r join tables into one, eval=FALSE}
# Join plane, engine, acf, type engine and type aircraft tables
my_planes <- raw_planes %>%
  left_join(raw_engine, by = c("eng_mfr_mdl" = "code")) %>%
  left_join(type_engine, by = "type") %>%
  left_join(raw_acf, by = c("mfr_mdl_code" = "code")) %>%
  mutate(type_acft = as.character(type_acft)) %>%
  left_join(type_aircraft, by = c("type_acft" = "type")) %>%
  clean_names() %>%
  select(n_number, # tailnum
         year_mfr,# year
         aircraft_desc, # type
         mfr_y, # manufacturer
         model_y, # model
         no_eng, #no of engines
         no_seats, #seats
         speed, #speed
         engine_desc) %>% #engine in char
  # Rename col names
  rename(tailnum = n_number,
         year = year_mfr,
         type = aircraft_desc,
         manufacturer = mfr_y,
         model = model_y,
         engines = no_eng,
         seats = no_seats,
         engine = engine_desc) %>%
  mutate(tailnum = paste0("N",tailnum)) %>%
  # Convert the data type, make them as same as nycflight13::planes
  mutate(year = as.integer(year),
         engines = as.integer(engines),
         seats = as.integer(seats),
         speed = as.integer(speed)) %>%
  # remove missing values, due to some planes being deregisted
  filter(!is.na(type)) %>%
  filter(!is.na(model)) 

save(my_planes, file = here::here("data","my_planes.rda"))
```


```{r read weather data, eval=FALSE}
raw_weather <- read_csv(here::here("raw_data","asos_ATL.txt"))
```

```{r my weather data, eval=FALSE}
my_weather <- raw_weather %>%
  select(station, valid, tmpf, dwpf, relh, drct, sknt, p01i, alti, vsby, gust) %>%
  mutate(year = year(valid),
         month = month(valid),
         day = day(valid),
         hour = hour(valid)) %>%
  rename(origin = station,
         time_hour = valid,
         temp = tmpf,
         humid = relh,
         wind_dir = drct,
         dewp = dwpf,
         wind_speed = sknt,
         precip = p01i,
         pressure = alti,
         visib = vsby,
         wind_gust = gust) %>%
  select(origin, year, month, day, hour, temp, dewp, humid, wind_dir, wind_speed, wind_gust, precip, pressure, visib, time_hour) %>%
  # Convert the data type, make them as same as nycflight13::weather
  mutate(year = as.integer(year),
         month = as.integer(month),
         temp = as.double(temp),
         dewp = as.double(dewp),
         humid = as.double(humid),
         wind_dir = as.double(wind_dir),
         wind_speed = as.double(wind_speed),
         wind_gust = as.double(wind_gust),
         precip = as.double(precip))

save(my_weather, file = here::here("data", "my_weather.rda"))
```


```{r ATL wiki page, eval=FALSE}
url_city <- ("https://en.wikipedia.org/wiki/Atlanta")
```


```{r bow, eval=FALSE}
# Test whether the website is scrapable
ATL_wiki <- url_city %>%
  bow() %>% scrape()
```

```{r scraping, eval=FALSE}
# scrape the population from wikipedia
ATL_pop <- ATL_wiki %>% html_nodes(".mergedrow:nth-child(29) td") %>% html_text() %>% parse_number()

# scrape the major's name from wikipedia
ATL_mayor <- ATL_wiki %>% html_nodes(".mergedrow:nth-child(18) td") %>% html_text()

# scrape the Metro area from wikipedia
ATL_area <- ATL_wiki %>% html_nodes(".mergedrow:nth-child(25) td") %>% html_text() %>% 
  parse_number()

# scrape the zip from wikipedia
ATL_zip <- ATL_wiki %>% html_nodes(".postal-code") %>% html_text()

# scrape the fip from wikipedia
ATL_fip <- ATL_wiki %>% html_nodes(".mergedtoprow:nth-child(42) td") %>% html_text() %>% str_sub(end = 8)

# create table
my_city <- tibble(
  faa = "ATL",
  pop = ATL_pop,
  mayor = ATL_mayor,
  area = ATL_area,
  zip = ATL_zip,
  fip = ATL_fip
)

save(my_city, file = here::here("data", "my_city.rda"))
```





## `r emo::ji("airplane")` Exercise 4

This report is visible on [my GitHub](https://github.com/ycui0008/5512-assignment4). The README.md file specifies the data sets in the data folder. It contains the variable explanations. The data source of rda files in data folder are shown in Acknowledgments section. The variables of the data sets are listed in the README.md.

## Acknowledgments

Data for Exercise 3:

- flights data was downloaded from [Bureau of Transportation Statistics](https://www.transtats.bts.gov/DL_SelectFields.asp?Table_ID=236)
- airports and airlines data were downloaded from [Airport, airline and route data](https://openflights.org/data.html)
- planes data was downloaded from [Federal Aviation Administration](https://www.faa.gov/licenses_certificates/aircraft_certification/aircraft_registry/releasable_aircraft_download/)
- weather data was downloaded from [Iowa State University](https://mesonet.agron.iastate.edu/request/download.phtml?network=GA_ASOS)
- city data was scraped from [wikipedia - Atlanta](https://en.wikipedia.org/wiki/Atlanta)

Thanks to nycflight13 [@nycflight13]. I made the rda files and README.md following the documentation of *nycflights13*.

Packages used to produce this assignment are:

tidyverse [@tidyverse], ggmap [@ggmap], ggthemes [@ggthemes], lutz [@lutz], lubridate [@lubridate], kableExtra [@kableExtra], janitor [@janitor], viridis [@viridis], bookdown [@bookdown]

## References
