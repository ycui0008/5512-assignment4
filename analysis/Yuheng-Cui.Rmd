---
title: "ETC5512 Assignment 4: An Analysis of US Air Traffic"
subtitle: "ATL airport"
author: "Yuheng Cui"
date: "June 19,  2020"
bibliography: references.bib
biblio-style: authoryear-comp
output: 
  bookdown::html_document2:
    toc: true
    citation_package: biblatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      cache=TRUE, 
                      messages=FALSE, 
                      warning=FALSE)
library(tidyverse)
library(DBI)
library(ggmap)
library(ggthemes)
# for exercise 2
library(lutz)
library(lubridate)
library(kableExtra)
library(janitor)
library(viridis)
library(bookdown)
```


## `r emo::ji("airplane")` Exercise 1

### a. 
```{r read flight data}
d <- read_csv(here::here("raw_data","On_Time_Reporting_Carrier_On_Time_Performance_(1987_present)_2020_2.csv"))
```

```{r choose one carrier}
ca <- d %>%
  filter(Reporting_Airline == "UA")
save(ca, file = here::here("data","airlines.rda"))
```

```{r choose one airport}
airport <- d %>%
  filter(Origin == "ATL" | Dest == "ATL")
save(airport, file = here::here("data","airport_ATL.rda"))
```


Here, I chose ATL airport and UA airline.

### b. 
```{r read airport data}
d1 <- read_csv(here::here("raw_data","516691980_T_MASTER_CORD.csv"))
```

```{r join d1 into airport}
airport_location <- d1 %>%
  filter(AIRPORT_IS_CLOSED == 0 & # select the airports are still on businesses at the time
           AIRPORT_IS_LATEST == 1 &
           AIRPORT_COUNTRY_CODE_ISO == "US") %>% 
  select(AIRPORT, DISPLAY_AIRPORT_NAME, LONGITUDE, LATITUDE)

flight <- airport %>%
  left_join(airport_location, by = c("Origin" = "AIRPORT")) %>%
  rename("Origin_lon" = "LONGITUDE","Origin_lat" = "LATITUDE") %>% # rename origin airport longitude and latitude
  left_join(airport_location, by = c("Dest" = "AIRPORT")) %>%
  rename("Dest_lon" = "LONGITUDE","Dest_lat" = "LATITUDE") # rename dest airport longitude and latitude

save(flight,file = here::here("data","flights.rda"))
```



### c. 
```{r generate a map of US}
usa_bbox <- c(-130, # min long
              20, # min lat
              -60, # max long
              55) # max lat

usa_map <- get_map(location = usa_bbox, source = "osm")
```

```{r choose UA in flight data set}
flight_UA <- flight %>%
  filter(Reporting_Airline == "UA")
```


```{r flight path}
ggmap(usa_map) + geom_segment(data=flight_UA, 
                     aes(x=Origin_lon, 
                         xend=Dest_lon,
                         y=Origin_lat,
                         yend=Dest_lat), 
                     colour="#7434eb", size = 2, alpha=0.01) +
  geom_point(data=flight, aes(x=Origin_lon, Origin_lat),
             colour="#f5ed00", alpha=0.1, size=1.5) +
  theme_map()
```

The level of transparency of the lines specifies how often does UA carry flights between ATL airport and other airports in Feb 2020. The deeper the color means more flights.

## `r emo::ji("airplane")` Exercise 2

### a. 
```{r standardise timezone}
flights_NYtime <- flight %>%
  filter(!is.na(Origin_lon)) %>%
  filter(!is.na(Dest_lon)) %>%
  filter(!is.na(DepTime)) %>%
  mutate(origin_tz = tz_lookup_coords(Origin_lat,
                                      Origin_lon, 
                                      warn = FALSE),
         dest_tz = tz_lookup_coords(Dest_lat,
                                    Dest_lon,
                                    warn = FALSE)) %>%
  mutate(Dep_DateTime = paste0(FlightDate, 
                           " ",
                           substr(DepTime, 1, 2),":", 
                           substr(DepTime, 3, 4), ":00")) %>%
  mutate(Origin_DateTime_NY = force_tzs(ymd_hms(Dep_DateTime),
      tzones = origin_tz, tzone_out = "America/New_York")) %>% # Normalise Dep DateTime
  mutate(Arr_DateTime = paste0(FlightDate,
                               " ",
                               substr(ArrTime, 1, 2),":", 
                               substr(ArrTime, 3, 4), ":00")) %>%
  mutate(Dest_DateTime_NY = force_tzs(ymd_hms(Arr_DateTime),
      tzones = dest_tz, tzone_out = "America/New_York"))

flights_NYtime %>%
  select(Origin_DateTime_NY, Dest_DateTime_NY, Tail_Number, Origin, Dest) %>%
  head()%>%
  kable(booktabs = TRUE, caption = "Flights-after normalise as NY Time")%>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```



### b. 
```{r list of plane}
# the list of planes that has flown in and out of the selected airport
flights_NYtime %>%
  group_by(Tail_Number, DayofMonth) %>%
  tally() %>%
  filter(n == 2) %>%
  select(Tail_Number, DayofMonth)
```

```{r choose one plane from the list above}
# Select a plane whose tail number was N7823A
day1 <- flights_NYtime %>%
  filter(Tail_Number == "N7823A", DayofMonth == 24)

ggmap(usa_map) +
  geom_segment(data=day1, 
                     aes(x=Origin_lon, 
                         xend=Dest_lon,
                         y=Origin_lat,
                         yend=Dest_lat), 
                     colour="Red", size = 1) +
  geom_point(data=day1, aes(x=Origin_lon, y = Origin_lat),
             colour="#746FB2", size=2) +
  geom_point(data=day1, aes(x=Dest_lon, y = Dest_lat),
             colour="#746FB2", size=2)
  theme_map()

```



### c. 
```{r animated fath way}
p1 <- day1 %>%
  mutate(AirTime_inter = AirTime/15) %>%
  mutate(Arr_DateTime = paste0(FlightDate, 
                           " ",
                           substr(ArrTime, 1, 2),":", 
                           substr(ArrTime, 3, 4), ":00"))%>%
  select(Origin_lon, Origin_lat, Dest_lon, Dest_lat, Dep_DateTime, Arr_DateTime, AirTime_inter)
```

```{r calculate the intervals}
p2 <-p1 %>%
  mutate(lon_inter = Dest_lon - Origin_lon,
         lat_inter = Dest_lat - Origin_lat) %>%
  mutate(lon_incre = lon_inter/AirTime_inter,
         lat_incre = lat_inter/AirTime_inter) %>%
  mutate(Dep_DateTime = ymd_hms(Dep_DateTime)) %>%
  arrange(Dep_DateTime)

p2
```

```{r}
step <- hms("00:15:00") # The time interval is 15 mins

```

```{r generate sequences}
lon_1 <- as.tibble(seq(p2$Origin_lon[1], p2$Dest_lon[1], by = p2$lon_incre[1]))
lat_1 <- as.tibble(seq(p2$Origin_lat[1], p2$Dest_lat[1], by = p2$lat_incre[1]))
tibble1 <-bind_cols(lon_1,lat_1) %>% clean_names() %>%
  rename(Origin_lon = value_1, Origin_lat = value_2)


lon_2 <- as.tibble(seq(p2$Origin_lon[2], p2$Dest_lon[2], by = p2$lon_incre[2]))
lat_2 <- as.tibble(seq(p2$Origin_lat[2], p2$Dest_lat[2], by = p2$lat_incre[2]))
tibble2 <-bind_cols(lon_2,lat_2) %>% clean_names() %>%
  rename(Origin_lon = value_1, Origin_lat = value_2)

path <- bind_rows(p2[1,][1:2], tibble1, tibble2, p2[2,][3:4]) #The movement of airplane

path$id <- seq.int(nrow(path))  
```

```{r one plane one path}
ggmap(usa_map)+
  geom_point(data=day1, 
             aes(x=Origin_lon, 
                 y=Origin_lat), 
             colour="Red", size = 1) +
  geom_point(data = path, aes(x = Origin_lon, y = Origin_lat, color = id)) +
  scale_color_viridis_c(option = "C") +
  geom_point(data=day1, aes(x=Origin_lon, y = Origin_lat),
             colour="#746FB2", size=2) +
  geom_point(data=day1, aes(x=Dest_lon, y = Dest_lat),
             colour="#746FB2", size=2)+
  theme_map()
```







### d. 
```{r one plane, animation.hook='gifski', out.width="100%", fig.width=4, fig.height=2}
for (i in 1:nrow(path)){
  print(ggmap(usa_map)+
          geom_point(data=day1, aes(x=Origin_lon, y = Origin_lat),
             colour="Red", size=2) +
          geom_point(data=day1, aes(x=Dest_lon, y = Dest_lat),
             colour="Red", size=2) +
          geom_point(data = path, aes(x = path[[1]][i], y = path[[2]][i]),color = 'White') +
  theme_map())
}
```
### test
```{r}
day1 %>%
  mutate(AirTime_inter = AirTime/15) %>%
  mutate(lon_incre = (Dest_lon - Origin_lon)/AirTime_inter,
         lat_incre = (Dest_lat - Origin_lat)/AirTime_inter) %>%
  select(DepTime, AirTime, Origin_lon, Origin_lat, Dest_lon, Dest_lat, lon_incre, lat_incre) %>%
  arrange(DepTime)
```



### e. 

```{r}
e4 <-flights_NYtime %>%
  filter(DayofMonth == 24, Reporting_Airline == "B6") %>%
  mutate(AirTime_inter = AirTime/15) %>%
  mutate(lon_incre = (Dest_lon - Origin_lon)/AirTime_inter,
         lat_incre = (Dest_lat - Origin_lat)/AirTime_inter) %>%
  select(DepTime, AirTime, Origin_lon, Origin_lat, Dest_lon, Dest_lat, DepDelay, lon_incre, lat_incre) %>%
  arrange(DepTime) %>%
  mutate(DepTime = paste0("2020-02-24 ",
                          substr(DepTime, 1, 2),
                          ":",
                          substr(DepTime, 3, 4))) %>%
  mutate(DepTime = ymd_hm(DepTime))

#e4
```


```{r}
# test1 <- (1:(e4$AirTime[1]%/%15))
# 
# #longitude change sequence
# ((e4$Dest_lon[1] - e4$Origin_lon[1])*15*test1)/(e4$AirTime[1]) + e4$Origin_lon[1]
# 
# #latitude change sequence
# ((e4$Dest_lat[1] - e4$Origin_lat[1])*15*test1)/(e4$AirTime[1]) + e4$Origin_lat[1]
# 
# #time change
# e4$DepTime[1] + step*test1
```

```{r create function}
pathtable <- function(i){
  test1 <- (1:(e4$AirTime[i]%/%15))
  
  #longitude change sequence
  lon_incre <- ((e4$Dest_lon[i] - e4$Origin_lon[i])*15*test1)/(e4$AirTime[i]) + e4$Origin_lon[i]

  #latitude change sequence
  lat_incre <- ((e4$Dest_lat[i] - e4$Origin_lat[i])*15*test1)/(e4$AirTime[i]) + e4$Origin_lat[i]
  
  #time change
  time_incre <- e4$DepTime[i] + step*test1
  
  DepDelay <- rep(e4$DepDelay[i], (e4$AirTime[i]%/%15))
  
  tibble(
    DepTime = time_incre,
    Origin_lon = lon_incre,
    Origin_lat = lat_incre,
    DepDelay = DepDelay
  )
}
```

```{r path_way}
path_way <- bind_rows(pathtable(1),pathtable(2),pathtable(3),pathtable(4),pathtable(5),pathtable(6),pathtable(7),pathtable(8),pathtable(9),pathtable(10),pathtable(11),pathtable(12),pathtable(13),pathtable(14))
```

```{r gganimate}
library(gganimate)
```

```{r}
ggmap(usa_map) +
  geom_point(data = path_way, aes(x= Origin_lon, y = Origin_lat,size = DepDelay)) +
  #ggtitle("Time: {frame_DepTime}") +
  transition_time(DepTime) +
  ease_aes('linear')
```


## `r emo::ji("airplane")` Exercise 3

```{r new data flights}
new_d <-read_csv(here::here("raw_data","On_Time_Reporting_Carrier_On_Time_Performance_(1987_present)_2020_2.csv")) %>%
  select(Year, Month, DayofMonth, DepTime, CRSDepTime, DepDelay, ArrTime, CRSArrTime, ArrDelay, Reporting_Airline, Flight_Number_Reporting_Airline, Tail_Number, Origin, Dest, AirTime, Distance) %>%
  rename(Day = DayofMonth, sched_dep_time = CRSDepTime, sched_arr_time = CRSArrTime, Carrier = Reporting_Airline, Flight = Flight_Number_Reporting_Airline) %>%
  mutate(hour = substr(sched_dep_time,1,2), 
         minute = substr(sched_dep_time, 3, 4)) %>%
  mutate(time_hour = paste0(Year, "-", Month, "-", Day, 
                            " ",
                            hour, ":", minute)) %>%
  mutate(time_hour = as_datetime(time_hour, format = "%Y-%m-%d %H:%M")) %>%
  mutate(Year = as.integer(Year),
         Month = as.integer(Month),
         Day = as.integer(Day),
         DepTime = as.integer(DepTime),
         sched_dep_time = as.integer(sched_dep_time),
         ArrTime = as.integer(ArrTime),
         sched_arr_time = as.integer(sched_arr_time),
         Flight = as.integer(Flight),
         hour = as.double(hour),
         minute = as.double(minute)) %>%
  filter(Origin == "ATL" | Dest == "ATL")

save(new_d, file = here::here("data","my_flights.rda"))
```

```{r new data airlines}
# Download raw data
url_airlines <- ("https://raw.githubusercontent.com/jpatokal/openflights/master/data/airlines.dat")
download.file(url_airlines, destfile = here::here("raw_data","airlines.csv"))

# Read data and add col names
new_airlines <- read_csv(here::here("raw_data","airlines.csv"), col_names = c("Airline ID", "Name", "Alias", "IATA", "ICAO", "Callsign", "Country", "Active")) %>%
  clean_names() %>% 
  filter(country == "United States", active =="Y")
  
new_airlines <- new_airlines %>%
  select(iata, name) %>%
  rename(carrier = iata)

save(new_airlines, file = here::here("data","my_airlines.rda"))
```

```{r new data airport}
# Download raw data
url_airport <- ("https://raw.githubusercontent.com/jpatokal/openflights/master/data/airports.dat") 
download.file(url_airport, destfile = here::here("raw_data","airports.csv"))

# Read data and add col names
new_airport <- read_csv(here::here("raw_data","airports.csv"), col_names = c("Airport ID", "Name", "City", "Country", "IATA", "ICAO", "Latitude", "Longitude", "Altitude", "Timezone", "DST", "Tz database time zone", "Type", "Source")) %>% 
  clean_names() %>%
  filter(country == "United States")

new_airport <- new_airport %>%
  select(iata, name, latitude, longitude, altitude, timezone, dst, tz_database_time_zone) %>%
  rename(faa = iata, lat = latitude, lon = longitude, alt = altitude, tz = timezone, tzone = tz_database_time_zone) %>%
  mutate(dst = parse_character(dst))

save(new_airport, file = here::here("data","my_airports.rda"))
```

```{r new data planes}
raw_planes <- read_csv(here::here("raw_data/ReleasableAircraft/MASTER.TXT")) %>% clean_names()
raw_engine <- read_csv(here::here("raw_data/ReleasableAircraft/ENGINE.TXT")) %>% clean_names()
raw_acf <- read_csv(here::here("raw_data/ReleasableAircraft/ACFTREF.TXT")) %>% clean_names()
```

```{r ducumentation}
# Find out the Descriptions for type engine and type aircraft
# Create table for Type Engine
type_engine <- tibble(type = c(0:11), engine_desc = c("None","Reciprocating", "Turbo-prop", "Turbo-shaft","Turbo-jet","Turbo-fan","Ramjet","2 Cycle","4 Cycle","Unknown","Electric","Rotary"))

# Create table for Type Aircraft
type_aircraft <- tibble(type = c(1:9,"H","O"), aircraft_desc = c("Glider","Balloon",
"Blimp/Dirigible",
"Fixed wing single engine",
"Fixed wing multi engine",
"Rotorcraft",
"Weight-shift-control",
"Powered Parachute",
"Gyroplane",
"Hybrid Lift",
"Other"))
```

```{r join tables into one}
# Join plane, engine, acf, type engine and type aircraft tables
my_planes <- raw_planes %>%
  left_join(raw_engine, by = c("eng_mfr_mdl" = "code")) %>%
  left_join(type_engine, by = "type") %>%
  left_join(raw_acf, by = c("mfr_mdl_code" = "code")) %>%
  mutate(type_acft = as.character(type_acft)) %>%
  left_join(type_aircraft, by = c("type_acft" = "type")) %>%
  clean_names() %>%
  select(n_number, # tailnum
         year_mfr,# year
         aircraft_desc, # type
         mfr_y, # manufacturer
         model_y, # model
         type, #engines in numeric
         no_seats, #seats
         speed, #speed
         engine_desc) %>% #engine in char
  # Rename col names
  rename(tailnum = n_number,
         year = year_mfr,
         type = aircraft_desc,
         manufacturer = mfr_y,
         model = model_y,
         engines = type,
         seats = no_seats,
         engine = engine_desc) %>%
  mutate(tailnum = paste0("N",tailnum)) %>%
  # Convert the variable types into right types
  mutate(year = as.integer(year),
         engines = as.integer(engines),
         seats = as.integer(seats),
         speed = as.integer(speed))

save(my_planes, file = here::here("data","my_planes.rda"))
```


```{r read weather data}
raw_weather <- read_csv(here::here("raw_data","asos_ATL.txt"))
```

```{r my weather data}
my_weather <- raw_weather %>%
  select(station, valid, tmpf, dwpf, relh, drct, sknt, p01i, alti, vsby, gust) %>%
  mutate(year = year(valid),
         month = month(valid),
         day = day(valid),
         hour = hour(valid)) %>%
  rename(origin = station,
         time_hour = valid,
         temp = tmpf,
         humid = relh,
         wind_dir = drct,
         dewp = dwpf,
         wind_speed = sknt,
         precip = p01i,
         pressure = alti,
         visib = vsby,
         wind_gust = gust) %>%
  select(origin, year, month, day, hour, temp, dewp, humid, wind_dir, wind_speed, wind_gust, precip, pressure, visib, time_hour) %>%
  mutate(year = as.integer(year),
         month = as.integer(month),
         temp = as.double(temp),
         dewp = as.double(dewp),
         humid = as.double(humid),
         wind_dir = as.double(wind_dir),
         wind_speed = as.double(wind_speed),
         wind_gust = as.double(wind_gust),
         precip = as.double(precip))

save(my_weather, file = here::here("data", "my_weather.rda"))
```


```{r load packages}
library(polite)
library(rvest)
```

```{r ATL wiki page}
url_city <- ("https://en.wikipedia.org/wiki/Atlanta")
```


```{r}
# Test whether the website is scrapable
ATL_wiki <- url_city %>%
  bow() %>% scrape()
```

```{r scraping}
# scrape the population from wikipedia
ATL_pop <- ATL_wiki %>% html_nodes(".mergedrow:nth-child(29) td") %>% html_text() %>% parse_number()

# scrape the major's name from wikipedia
ATL_mayor <- ATL_wiki %>% html_nodes(".mergedrow:nth-child(18) td") %>% html_text()

# scrape the Metro area from wikipedia
ATL_area <- ATL_wiki %>% html_nodes(".mergedrow:nth-child(25) td") %>% html_text() %>% 
  parse_number()

# scrape the zip from wikipedia
ATL_zip <- ATL_wiki %>% html_nodes(".postal-code") %>% html_text()

# scrape the fip from wikipedia
ATL_fip <- ATL_wiki %>% html_nodes(".mergedtoprow:nth-child(42) td") %>% html_text() %>% str_sub(end = 8)

# create table
my_city <- tibble(
  faa = "ATL",
  pop = ATL_pop,
  mayor = ATL_mayor,
  area = ATL_area,
  zip = ATL_zip,
  fip = ATL_fip
)

save(my_city, file = here::here("data", "my_city.rda"))
```





## `r emo::ji("airplane")` Exercise 4

This report is visible on [my GitHub](https://github.com/ycui0008/5512-assignment4). The README.md file specifies the data sets in the data folder. It contains the variable explanations.

## Acknowledgments

Data for Exercise 3:

- flights data was downloaded from [Bureau of Transportation Statistics](https://www.transtats.bts.gov/DL_SelectFields.asp?Table_ID=236)
- airports and airlines data were downloaded from [Airport, airline and route data](https://openflights.org/data.html)
- planes data was downloaded from [Federal Aviation Administration](https://www.faa.gov/licenses_certificates/aircraft_certification/aircraft_registry/releasable_aircraft_download/)
- weather data was downloaded from [Iowa State University](https://mesonet.agron.iastate.edu/request/download.phtml?network=GA_ASOS)
- city data was scraped from [wikipedia - Atlanta](https://en.wikipedia.org/wiki/Atlanta)

Thanks to Hadley Wickham, the owner and maker of nycflights13 packages. I made the rda files and README.md following the documentation of nycflights13 (e.g. using same variable names, types, units).

Packages used to produce this assignment are:

tidyverse [@tidyverse], ggmap [@ggmap], ggthemes [@ggthemes], lutz [@lutz], lubridate [@lubridate], kableExtra [@kableExtra], janitor [@janitor], viridis [@viridis], bookdown [@bookdown]

## References

Cite  the main sources for your work, including R packages used.